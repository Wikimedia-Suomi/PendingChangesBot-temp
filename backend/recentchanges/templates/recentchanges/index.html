<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Wikipedia Recent Edits</title>
    <style>
      :root {
        font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
        background: #f3f4f6;
        color: #111827;
      }

      body {
        margin: 0;
        padding: 0;
      }

      .top-bar {
        background: white;
        border-bottom: 1px solid #e5e7eb;
        padding: 0.75rem 1.5rem;
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 1rem;
        position: sticky;
        top: 0;
        z-index: 10;
      }

      .brand {
        font-weight: 600;
        font-size: 1.1rem;
      }

      .nav-actions {
        display: flex;
        align-items: center;
        gap: 1rem;
        flex-wrap: wrap;
      }

      main {
        max-width: 960px;
        margin: 0 auto;
        padding: 2.5rem 1.5rem 4rem;
      }

      .controls {
        display: flex;
        gap: 1rem;
        justify-content: center;
        align-items: center;
        flex-wrap: wrap;
        margin-bottom: 1.5rem;
      }

      select,
      button {
        padding: 0.5rem 1rem;
        font-size: 1rem;
        border-radius: 0.5rem;
        border: 1px solid #d1d5db;
        background: white;
        cursor: pointer;
      }

      button {
        background: #2563eb;
        color: white;
        border: none;
      }

      button:hover {
        background: #1d4ed8;
      }

      ul {
        list-style: none;
        padding: 0;
        margin: 0;
        display: grid;
        gap: 1rem;
      }

      li {
        background: white;
        border-radius: 0.75rem;
        padding: 1rem 1.25rem;
        box-shadow: 0 10px 20px rgba(15, 23, 42, 0.08);
      }

      li.auto-approved {
        background: #dcfce7;
        border: 1px solid #86efac;
        box-shadow: 0 10px 20px rgba(22, 163, 74, 0.12);
      }

      .meta {
        font-size: 0.9rem;
        color: #6b7280;
      }

      a {
        color: #2563eb;
        text-decoration: none;
      }

      a:hover {
        text-decoration: underline;
      }

      .error {
        color: #dc2626;
        text-align: center;
        margin-bottom: 1rem;
      }

      .empty {
        text-align: center;
        color: #6b7280;
      }
    </style>
  </head>
  <body>
    {% verbatim %}
    <div id="app">
      <header class="top-bar">
        <div class="brand">Wikipedia Recent Edits</div>
        <div class="nav-actions">
          <label>
            Language
            <select v-model="selectedLanguage" @change="fetchEdits">
              <option v-for="lang in languages" :key="lang" :value="lang">
                {{ lang.toUpperCase() }}
              </option>
            </select>
          </label>
          <a :href="configUrl">Config</a>
        </div>
      </header>
      <main>
        <section class="controls">
          <button type="button" @click="fetchEdits" :disabled="loading">
            {{ loading ? 'Loadingâ€¦' : 'Refresh' }}
          </button>
          <p class="meta">Showing up to {{ limit }} recent edits.</p>
        </section>

        <p class="error" v-if="error">{{ error }}</p>
        <p class="empty" v-else-if="!loading && edits.length === 0">
          No edits available.
        </p>

        <ul v-if="edits.length">
          <li
            v-for="edit in edits"
            :key="edit.newid || edit.timestamp"
            :class="{ 'auto-approved': edit.auto_approved }"
          >
            <h2>{{ edit.title }}</h2>
            <p class="meta">
              Edited by <strong>{{ edit.user || 'Unknown editor' }}</strong>
              on {{ formatTimestamp(edit.timestamp) }}
            </p>
            <p v-if="edit.comment">Comment: {{ edit.comment }}</p>
            <p>
              <a :href="diffUrl(edit)" target="_blank" rel="noopener noreferrer">
                View diff
              </a>
            </p>
          </li>
        </ul>
      </main>
    </div>
    {% endverbatim %}

    <script src="https://unpkg.com/vue@3/dist/vue.global.prod.js"></script>
    <script>
      const supportedLanguages = JSON.parse('{{ supported_languages_json|escapejs }}');
      const defaultLanguage = '{{ default_language|escapejs }}';
      const apiUrl = '{{ api_url|escapejs }}';
      const configUrl = '{{ config_url|escapejs }}';
      const defaultEditLimit = Number('{{ default_edit_limit|escapejs }}') || 50;
      const minEditLimit = Number('{{ min_edit_limit|escapejs }}') || 1;
      const maxEditLimit = Number('{{ max_edit_limit|escapejs }}') || 200;

      const storageKey = 'recentChangesPreferences';

      const clampLimit = (value) => {
        const parsed = Number.parseInt(value ?? defaultEditLimit, 10);
        if (!Number.isFinite(parsed)) {
          return defaultEditLimit;
        }
        return Math.min(maxEditLimit, Math.max(minEditLimit, parsed));
      };

      const loadPreferences = () => {
        try {
          const raw = localStorage.getItem(storageKey);
          if (!raw) {
            return {};
          }
          const parsed = JSON.parse(raw);
          if (!parsed || typeof parsed !== 'object') {
            return {};
          }
          return parsed;
        } catch (error) {
          console.warn('Failed to load preferences:', error);
          return {};
        }
      };

      const savePreferencesToStorage = (preferences) => {
        try {
          localStorage.setItem(storageKey, JSON.stringify(preferences));
        } catch (error) {
          console.warn('Failed to save preferences:', error);
        }
      };

      const { createApp } = Vue;

      createApp({
        data() {
          const savedPreferences = loadPreferences();
          const initialLanguage =
            savedPreferences.language && supportedLanguages.includes(savedPreferences.language)
              ? savedPreferences.language
              : defaultLanguage;
          const initialLimit = clampLimit(savedPreferences.limit);
          return {
            languages: supportedLanguages,
            selectedLanguage: initialLanguage,
            limit: initialLimit,
            edits: [],
            error: '',
            loading: false,
            configUrl,
          };
        },
        mounted() {
          this.savePreferences();
          this.fetchEdits();
        },
        watch: {
          selectedLanguage(newLanguage) {
            if (!this.languages.includes(newLanguage)) {
              return;
            }
            this.savePreferences();
          },
        },
        methods: {
          savePreferences() {
            const preferences = {
              language: this.selectedLanguage,
              limit: clampLimit(this.limit),
            };
            savePreferencesToStorage(preferences);
          },
          async fetchEdits() {
            this.loading = true;
            this.error = '';
            try {
              const params = new URLSearchParams({
                lang: this.selectedLanguage,
                limit: String(clampLimit(this.limit)),
              });
              const response = await fetch(`${apiUrl}?${params.toString()}`);
              if (!response.ok) {
                throw new Error(`Failed to load data (status ${response.status})`);
              }
              const payload = await response.json();
              this.edits = payload.edits || [];
              if (typeof payload.limit === 'number') {
                this.limit = clampLimit(payload.limit);
                this.savePreferences();
              }
            } catch (error) {
              this.error = error.message || 'Failed to load data.';
              this.edits = [];
            } finally {
              this.loading = false;
            }
          },
          diffUrl(edit) {
            const encodedTitle = encodeURIComponent(edit.title);
            const base = `https://${this.selectedLanguage}.wikipedia.org`;
            if (edit.newid && edit.oldid) {
              return `${base}/w/index.php?title=${encodedTitle}&type=revision&diff=${edit.newid}&oldid=${edit.oldid}`;
            }
            if (edit.newid) {
              return `${base}/w/index.php?title=${encodedTitle}&oldid=${edit.newid}`;
            }
            return `${base}/wiki/${encodedTitle}`;
          },
          formatTimestamp(timestamp) {
            if (!timestamp) {
              return 'unknown time';
            }
            const date = new Date(timestamp);
            return isNaN(date.getTime()) ? timestamp : date.toLocaleString();
          },
        },
      }).mount('#app');
    </script>
  </body>
</html>
