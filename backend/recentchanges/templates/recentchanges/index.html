<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Wikipedia Recent Edits</title>
    <style>
      :root {
        font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
        background: #f3f4f6;
        color: #111827;
      }

      body {
        margin: 0;
        padding: 0;
      }

      main {
        max-width: 960px;
        margin: 0 auto;
        padding: 2rem 1.5rem 4rem;
      }

      h1 {
        text-align: center;
        margin-bottom: 1.5rem;
      }

      .controls {
        display: flex;
        gap: 1rem;
        justify-content: center;
        align-items: center;
        flex-wrap: wrap;
        margin-bottom: 1.5rem;
      }

      select,
      button {
        padding: 0.5rem 1rem;
        font-size: 1rem;
        border-radius: 0.5rem;
        border: 1px solid #d1d5db;
        background: white;
        cursor: pointer;
      }

      button {
        background: #2563eb;
        color: white;
        border: none;
      }

      button:hover {
        background: #1d4ed8;
      }

      ul {
        list-style: none;
        padding: 0;
        margin: 0;
        display: grid;
        gap: 1rem;
      }

      li {
        background: white;
        border-radius: 0.75rem;
        padding: 1rem 1.25rem;
        box-shadow: 0 10px 20px rgba(15, 23, 42, 0.08);
      }

      .meta {
        font-size: 0.9rem;
        color: #6b7280;
      }

      a {
        color: #2563eb;
        text-decoration: none;
      }

      a:hover {
        text-decoration: underline;
      }

      .error {
        color: #dc2626;
        text-align: center;
        margin-bottom: 1rem;
      }

      .empty {
        text-align: center;
        color: #6b7280;
      }
    </style>
  </head>
  <body>
    {% verbatim %}
    <div id="app">
      <main>
        <h1>Wikipedia Recent Edits</h1>
        <section class="controls">
          <label>
            Language
            <select v-model="selectedLanguage" @change="fetchEdits">
              <option v-for="lang in languages" :key="lang" :value="lang">
                {{ lang.toUpperCase() }}
              </option>
            </select>
          </label>
          <button type="button" @click="fetchEdits" :disabled="loading">
            {{ loading ? 'Loadingâ€¦' : 'Refresh' }}
          </button>
        </section>

        <p class="error" v-if="error">{{ error }}</p>
        <p class="empty" v-else-if="!loading && edits.length === 0">
          No edits available.
        </p>

        <ul v-if="edits.length">
          <li v-for="edit in edits" :key="edit.newid || edit.timestamp">
            <h2>{{ edit.title }}</h2>
            <p class="meta">
              Edited by <strong>{{ edit.user || 'Unknown editor' }}</strong>
              on {{ formatTimestamp(edit.timestamp) }}
            </p>
            <p v-if="edit.comment">Comment: {{ edit.comment }}</p>
            <p>
              <a :href="diffUrl(edit)" target="_blank" rel="noopener noreferrer">
                View diff
              </a>
            </p>
          </li>
        </ul>
      </main>
    </div>
    {% endverbatim %}

    <script src="https://unpkg.com/vue@3/dist/vue.global.prod.js"></script>
    <script>
      const supportedLanguages = JSON.parse('{{ supported_languages_json|escapejs }}');
      const defaultLanguage = '{{ default_language|escapejs }}';
      const apiUrl = '{{ api_url|escapejs }}';

      const { createApp } = Vue;

      createApp({
        data() {
          return {
            languages: supportedLanguages,
            selectedLanguage: defaultLanguage,
            edits: [],
            error: '',
            loading: false,
          };
        },
        mounted() {
          this.fetchEdits();
        },
        methods: {
          async fetchEdits() {
            this.loading = true;
            this.error = '';
            try {
              const response = await fetch(`${apiUrl}?lang=${this.selectedLanguage}`);
              if (!response.ok) {
                throw new Error(`Failed to load data (status ${response.status})`);
              }
              const payload = await response.json();
              this.edits = payload.edits || [];
            } catch (error) {
              this.error = error.message || 'Failed to load data.';
              this.edits = [];
            } finally {
              this.loading = false;
            }
          },
          diffUrl(edit) {
            const encodedTitle = encodeURIComponent(edit.title);
            const base = `https://${this.selectedLanguage}.wikipedia.org`;
            if (edit.newid && edit.oldid) {
              return `${base}/w/index.php?title=${encodedTitle}&type=revision&diff=${edit.newid}&oldid=${edit.oldid}`;
            }
            if (edit.newid) {
              return `${base}/w/index.php?title=${encodedTitle}&oldid=${edit.newid}`;
            }
            return `${base}/wiki/${encodedTitle}`;
          },
          formatTimestamp(timestamp) {
            if (!timestamp) {
              return 'unknown time';
            }
            const date = new Date(timestamp);
            return isNaN(date.getTime()) ? timestamp : date.toLocaleString();
          },
        },
      }).mount('#app');
    </script>
  </body>
</html>
